<!DOCTYPE html><html lang="zh"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.625 -apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}h1{margin-left:0;margin-right:0;margin-top:2.4375rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.21875rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;border-bottom:1px solid hsla(0,0%,0%,0.07);}h2{margin-left:0;margin-right:0;margin-top:1.625rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.40625rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;border-bottom:1px solid hsla(0,0%,0%,0.07);}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:hsla(0,0%,0%,0.53);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}ul{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:0.85rem;line-height:1.625rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:1rem;line-height:1.625rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:calc(0.8125rem - 1px);padding-right:0;padding-top:0;margin-bottom:0.8125rem;border-left:4px solid hsla(0,0%,0%,0.13);color:hsla(0,0%,0%,0.53);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(0.8125rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}b{font-weight:600;}strong{font-weight:600;}dt{font-weight:600;}th{font-weight:600;}li{margin-bottom:calc(0.8125rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}li > ul{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(0.8125rem / 2);}code{font-size:0.85rem;line-height:1.625rem;}kbd{font-size:0.85rem;line-height:1.625rem;}samp{font-size:0.85rem;line-height:1.625rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.08333rem;padding-right:1.08333rem;padding-top:0.8125rem;padding-bottom:calc(0.8125rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}h3,h4,h5,h6{margin-bottom:0.8125rem;margin-top:1.625rem;}ol,ul{margin-left:2.03125rem;}li>ol,li>ul{margin-left:2.03125rem;}a{color:#4078c0;text-decoration:none;}a:hover,a:active{text-decoration:underline;}</style><title data-react-helmet="true">快速上手亚马逊的 Serverless 服务 | 云音乐大前端专栏</title><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="shortcut icon" href="/icons/icon-48x48.png?v=d8c4c3e0da7a96b81c222f3b61a1543f"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#dd001b"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=d8c4c3e0da7a96b81c222f3b61a1543f"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=d8c4c3e0da7a96b81c222f3b61a1543f"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=d8c4c3e0da7a96b81c222f3b61a1543f"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=d8c4c3e0da7a96b81c222f3b61a1543f"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=d8c4c3e0da7a96b81c222f3b61a1543f"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=d8c4c3e0da7a96b81c222f3b61a1543f"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=d8c4c3e0da7a96b81c222f3b61a1543f"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=d8c4c3e0da7a96b81c222f3b61a1543f"/><meta name="generator" content="Gatsby 2.15.7"/><meta data-react-helmet="true" name="description" content="Serverless 是一种执行模型（execution model）。在这种模型中，云服务商负责通过动态地分配资源来执行一段代码。"/><meta data-react-helmet="true" property="og:title" content="快速上手亚马逊的 Serverless 服务"/><meta data-react-helmet="true" property="og:description" content="Serverless 是一种执行模型（execution model）。在这种模型中，云服务商负责通过动态地分配资源来执行一段代码。"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="云音乐大前端团队"/><meta data-react-helmet="true" name="twitter:title" content="快速上手亚马逊的 Serverless 服务"/><meta data-react-helmet="true" name="twitter:description" content="Serverless 是一种执行模型（execution model）。在这种模型中，云服务商负责通过动态地分配资源来执行一段代码。"/><style data-href="/styles.a8f6e12462010344bfaf.css">@font-face{font-family:Source Code Pro;font-style:normal;font-display:swap;font-weight:200;src:local("Source Code Pro Extra Light "),local("Source Code Pro-Extra Light"),url(/static/source-code-pro-latin-200-41568fe7927570e049a6cb707930f353.woff2) format("woff2"),url(/static/source-code-pro-latin-200-568dcb298a36f14317fdcddf8eded62f.woff) format("woff")}@font-face{font-family:Source Code Pro;font-style:normal;font-display:swap;font-weight:300;src:local("Source Code Pro Light "),local("Source Code Pro-Light"),url(/static/source-code-pro-latin-300-248b2236ba6bb9d2745a4908bc9c4568.woff2) format("woff2"),url(/static/source-code-pro-latin-300-43fcfcf552695ff0976d7d03a29835c4.woff) format("woff")}@font-face{font-family:Source Code Pro;font-style:normal;font-display:swap;font-weight:400;src:local("Source Code Pro Regular "),local("Source Code Pro-Regular"),url(/static/source-code-pro-latin-400-1c37ab07cfefc70a85445f49737ad28a.woff2) format("woff2"),url(/static/source-code-pro-latin-400-a4a08973559a45aba173184ea065addf.woff) format("woff")}@font-face{font-family:Source Code Pro;font-style:normal;font-display:swap;font-weight:500;src:local("Source Code Pro Medium "),local("Source Code Pro-Medium"),url(/static/source-code-pro-latin-500-67f6c1995acae33eacb1af1807c0e8c8.woff2) format("woff2"),url(/static/source-code-pro-latin-500-a39fc2de145c00ef5898c77b15c27517.woff) format("woff")}@font-face{font-family:Source Code Pro;font-style:normal;font-display:swap;font-weight:600;src:local("Source Code Pro SemiBold "),local("Source Code Pro-SemiBold"),url(/static/source-code-pro-latin-600-bf5d453754c3bd3e0fc9bcdc979048f1.woff2) format("woff2"),url(/static/source-code-pro-latin-600-c021e440e993ff26de945242222960a6.woff) format("woff")}@font-face{font-family:Source Code Pro;font-style:normal;font-display:swap;font-weight:700;src:local("Source Code Pro Bold "),local("Source Code Pro-Bold"),url(/static/source-code-pro-latin-700-b46da14cbd07b2f1f5ca74069d59318e.woff2) format("woff2"),url(/static/source-code-pro-latin-700-c86a17b160684a125455d36f4733ad85.woff) format("woff")}@font-face{font-family:Source Code Pro;font-style:normal;font-display:swap;font-weight:900;src:local("Source Code Pro Black "),local("Source Code Pro-Black"),url(/static/source-code-pro-latin-900-e985b6f17d53c2780c3c49722984a52e.woff2) format("woff2"),url(/static/source-code-pro-latin-900-b0d773d996cad7ea914d35d16dd0f3ec.woff) format("woff")}@font-face{font-family:Noto Sans;font-style:normal;font-display:swap;font-weight:400;src:local("Noto Sans Regular "),local("Noto Sans-Regular"),url(/static/noto-sans-latin-400-175853ded2a4e2249d37c46ca0ca33c5.woff2) format("woff2"),url(/static/noto-sans-latin-400-e7ccb0aa43af9fb7fae4d1bdc23a099b.woff) format("woff")}@font-face{font-family:Noto Sans;font-style:italic;font-display:swap;font-weight:400;src:local("Noto Sans Regular italic"),local("Noto Sans-Regularitalic"),url(/static/noto-sans-latin-400italic-baa3ec09eb827b4f10593032d1cf2a88.woff2) format("woff2"),url(/static/noto-sans-latin-400italic-14425b1ebbce551302a950b083b6c14e.woff) format("woff")}@font-face{font-family:Noto Sans;font-style:normal;font-display:swap;font-weight:700;src:local("Noto Sans Bold "),local("Noto Sans-Bold"),url(/static/noto-sans-latin-700-43750a193b8ff0b4e929323a72d79301.woff2) format("woff2"),url(/static/noto-sans-latin-700-a8edfe7bbf3b01666adc30c118cc5223.woff) format("woff")}@font-face{font-family:Noto Sans;font-style:italic;font-display:swap;font-weight:700;src:local("Noto Sans Bold italic"),local("Noto Sans-Bolditalic"),url(/static/noto-sans-latin-700italic-bc98820a9bf62004a88ef07e012e3ce3.woff2) format("woff2"),url(/static/noto-sans-latin-700italic-0e19737ff39f96eb1ff99e463fa457a4.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><link as="script" rel="preload" href="/styles-ad8e7b79adaf3a577ea0.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-788c454dbed28c00f3b8.js"/><link as="script" rel="preload" href="/app-0c9a63a3aef9e813df5b.js"/><link as="script" rel="preload" href="/commons-8d9941e7328683a5eecb.js"/><link as="script" rel="preload" href="/webpack-runtime-2742ada98d46151d1c6f.js"/><link as="fetch" rel="preload" href="/page-data/aws-serverless/page-data.json" crossorigin="anonymous"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:39rem;padding:2.4375rem 1.21875rem;font-family:&quot;Source Code Pro&quot;, &quot;Noto Sans CJK SC&quot;"><header><h1 style="font-size:2.2974rem;line-height:3.25rem;margin-top:0"><a style="box-shadow:none;text-decoration:none;color:#DD001B" href="/">云音乐大前端专栏</a></h1></header><main><article><header><h1 style="margin-top:1.625rem;margin-bottom:0;color:#001E26">快速上手亚马逊的 Serverless 服务</h1><p style="font-size:0.87055rem;line-height:1.625rem;display:block;margin-bottom:1.625rem">2019-09-12</p></header><section><p><img src="https://p1.music.126.net/kXHGCtyxu9hOvOWREE9wAA==/109951164358102755.jpg"></p>
<h2>什么是 Serverless ?</h2>
<h3>定义</h3>
<p>引用一段对于 Serverless 较为官方的定义：“Serverless 是一种执行模型（execution model）。在这种模型中，云服务商负责通过动态地分配资源来执行一段代码。云服务商仅仅收取执行这段代码所需要资源的费用。代码通常会被运行在一个无状态的容器内，并且可被多种事件触发（ http 请求、数据库事件、监控报警、文件上传、定时任务……）。代码常常会以函数（function）的形式被上传到云服务商以供执行，因此 Serverless 也会被称作 Functions as a Service 或者 FaaS。”</p>
<p>从定义中不难看出 Serverless 的出现免去了工程师在开发应用时对服务器与后端运维的考量，使工程师可以全心全意地投入业务逻辑代码的实现中去。再概括一下 Serverless 老生常谈的几条优势：</p>
<ul>
<li>应用开发迅速</li>
<li>无须考虑运维</li>
<li>按用量收费</li>
</ul>
<h3>对于开发者的意义</h3>
<ul>
<li>对于前端开发者来说，Serverless 的出现无疑大大降低了编写后端应用的门槛，并且赋予前端开发者开发完整前后端应用的能力。</li>
<li>对于企业及独立开发者来说，Serverless 的出现大大缩短了业务从开发至上线的时间，甚至可能会改变企业的传统前后端合作模式与人员结构。</li>
</ul>
<h3>应用场景</h3>
<blockquote>
<p>Serverless 对于前端开发者来说主要会有以下几个应用场景</p>
</blockquote>
<ul>
<li>开发后端接口：这是 Serverless 目前最为广泛应用的场景。通过搭配数据库等后端服务，可以实现低门槛、高效率的后端接口开发。</li>
<li>代替 NodeJS 服务器：Serverless 可以代替传统的 NodeJS 服务器，使我们可以更为便捷地实现原有的功能，例如后端数据适配前端、服务端渲染等。</li>
<li>搭建基于事件的服务：Serverless 基于事件触发的特性注定了它极为适合用于搭建基于事件的服务。例如我们可以通过监听特定的数据库事件来触发相关的业务逻辑。</li>
</ul>
<h2>什么是 AWS Lambda ?</h2>
<p>AWS Lambda 是由亚马逊云服务平台（ AWS ）最早推出于 2014 年、最为著名的 Serverless 云计算平台之一。相较于其他云服务商，AWS Lambda 以完善的设施（触发器种类多、支持编程语言多……）和丰富的社区支持在多数评测中占据了上风。从体验与学习的目的出发，AWS Lambda 可以说是我们的不二选择。</p>
<h2>Serverless 与 AWS Lambda 现存的问题</h2>
<h3>冷启动</h3>
<p>冷启动是最常被提到的问题之一，用简单的话来说就是当你的函数一段时间未被运行后，系统就会回收运行函数的容器资源。这样带来负面影响就是，当下一次调用这个函数时，就需要重新启动一个容器来运行你的函数，结果就是函数的调用会被<strong>延迟</strong>。来看一下在 AWS Lambda 上函数调用时间间隔与冷启动概率的关系：</p>
<p>  <img src="https://p1.music.126.net/K15YeeoLZ_d_ltwNsO-1gg==/109951164204761853.png?imageView&#x26;thumbnail=900x0"></p>
<p>  那么具体的延迟时间是多少呢？延迟时间受许多因素的影响，比如编程语言、函数的内存配置、函数的文件大小等等。但是一个较为普遍的建议就是 Lambda 不适合用作对延迟极其敏感的服务（&#x3C; 50ms）。</p>
<h3>迁移</h3>
<p>在使用 AWS Lambda 开发应用时，我们所写的代码与 AWS 这个云服务商是具有强关联性的。尽管目前有一些框架（例如下文会应用到的 Serverless 框架）来帮助我们抹平不同服务商之间的代码差异，想从一个服务商迁移至另一个服务商依然是一件繁重的体力劳动，甚至包含着一定的代码重构。</p>
<h3>代码维护</h3>
<p>函数式的开发模式注定了代码之间的复用与共享会成为一个难题，也注定了代码量会随着服务的增多而膨胀。 Serverless 会使得函数数量与代码量呈线性增长的关系，如下图</p>
<p>  <img src="https://p1.music.126.net/n935ASd-39I7UypUypFmrg==/109951164204774049.png?imageView&#x26;thumbnail=900x0"></p>
<p>  当服务达到一定数量后，维护一个无限膨胀的代码库所需要的额外人力与开支也是不可小视的。</p>
<h3>本地开发</h3>
<p>运行 AWS Lambda 的函数依赖于许多外部的库和应用（aws-sdk、API Gateway、DynamoDB...），因此想要在一个完全本地的环境运行这样的函数是十分困难的。如果我们每次修改函数后都需要部署并依赖于 AWS CloudWatch 中输出的运行日志来调试与开发 Lambda 函数，那想必效率是极低的。 <code class="language-text">Serverless CLI</code> 对于本地开发难的问题，提供了一定的插件来支持（<a href="https://github.com/dherault/serverless-offline">serverless-offline</a>、<a href="https://github.com/99xt/serverless-dynamodb-local">serverless-dynamodb-local</a>...）。不使用 <code class="language-text">Serverless CLI</code> 开发 Lambda 的用户可能就需要研读官方提供的<a href="https://github.com/awslabs/serverless-application-model"> AWS-SAM 文档</a>来配置本地开发环境了。</p>
<h3>计价方式</h3>
<p>AWS Lambda 收费的最小单位是 100ms ，也就是意味着你的函数哪怕只执行了 1ms 也会当作 100ms 来计费。这种计费方式在某些情况下甚至会导致使用高内存的函数比低内存的要便宜。我们来看下 AWS Lambda 的计费表:</p>
<p>  <img src="https://p1.music.126.net/bS3HASNqi8CH115arHV2xA==/109951164204769553.png"></p>
<p>  举一个较为极端的例子：假设我们设置了一个内存为 448MB 的函数，它运行时间为 101ms ，那么每次执行我们都需要支付 0.000000729 x 2 = $0.000001458 。而如果我们将这个函数的内存提高到 512MB ，使它的运行时间降低 100ms 以内，那么每次执行我们只需要支付 $0.000000834 。仅仅是一个设置，我们就降低了整整 (1458 - 834) / 1458 ≈ <strong>42.8%</strong> 的成本！</p>
<p>  找到性价比最高的内存设置意味着额外的工作量，很难想象 AWS 在这个问题上居然没有为客户提供一个合理的解决方案。</p>
<h3>捆绑消费</h3>
<p>在使用 AWS Lambda 时几乎所有的周边服务（API Gateway、CloudWatch、DynamoDB...）都是需要额外收费的。其中一个很明显的特征就是<strong>捆绑消费</strong>，你可能很难想象 CloudWatch 是在使用 Lambda 时被强制使用的一个服务；而 API Gateway 也是在搭建 http 服务时几乎无法逃过的一个收费站，其 <b>$3.5/百万次请求</b> 的高额价格甚至<strong>远远高于</strong>使用 Lambda 的价格。</p>
<h3>与传统云主机的费用权衡</h3>
<p>AWS Lambda 对于低计算复杂度、低流量的应用是有着绝对的价格优势的。但是当部署在 Lambda 上的函数复杂度与流量逐渐上升的时候，使用 Lambda 的成本是有可能在某一时间点超过传统云主机的。就好比使用 Lambda 是租车，而使用传统云主机是买车。但从另一角度看，使用 Serverless 服务又可以节省一定的开发与运维成本。因此对于“Serverless 与传统云主机谁更节省成本”这个问题，不仅与具体开发的应用类型有关，也与应用的开发模式密不可分，该问题的真正答案很可能只有通过精密的成本计算与实践才能得出。</p>
<h3>如何选择？</h3>
<p>虽然 Lambda 有以上值得权衡的问题，但它所带来对于开发效率的提高是史无前例的，它所带来对于服务器及运维层面的成本削减也是肉眼可见的。全面并且客观地了解 Lambda 的长处与短处是决定是否使用它的必要步骤。目前许多的外国企业及开发者已渐渐开始拥抱与接纳 Serverless 的开发模式，尽管国内可能对于 Serverless 应用范围并不是很广，尽早地了解与熟悉 Serverless 相信对于国内开发者来说也是百利而无一害的。</p>
<h2>在 AWS Lambda 上搭建服务</h2>
<blockquote>
<p>在了解了 Serverless 与 AWS Lambda 后，接下来我们就可以着手在 AWS Lambda 上开发应用了。</p>
</blockquote>
<h3>目标</h3>
<p>接下来时间内，我们要在 Lambda 上部署一套在应用开发中较为常见的用户服务，主要有注册、登录、与接口访问权限校验的功能，包含以下四个接口</p>
<ul>
<li><code class="language-text">/api/user/signup</code> - 创建一个新用户并录入数据库</li>
<li><code class="language-text">/api/user/login</code> - 登录并返回 JSON Web Token 来让用户访问私有接口</li>
<li><code class="language-text">/api/public</code> - 公共接口，无须登录的用户也可访问</li>
<li><code class="language-text">/api/private</code> - 私有接口，只有登录后的用户才能访问</li>
</ul>
<h3>预备知识</h3>
<ul>
<li><a href="https://www.w3schools.com/js/default.asp">JavaScript 基础语法</a></li>
<li><a href="https://medium.com/vandium-software/5-easy-steps-to-understanding-json-web-tokens-jwt-1164c0adfcec">JSON Web Token</a></li>
<li>
<p><a href="https://github.com/serverless/serverless">Serverless 应用框架</a></p>
<p><img src="https://p1.music.126.net/IJx3l3uiqB77QmYK9DZs0w==/109951164204770541.png?imageView&#x26;thumbnail=300x0" alt="Serverless"></p>
<p>这里的 Serverless 指的是一个在 GitHub 上超  过 3 万星的 CLI 工具。通过 Serverless CLI ，我们可以快速生成 Lambda 应用服务模版，标准化、工程化服务的开发以及一键部署服务至多套的环境与节点，极大地缩短了服务开发至上线的时间。</p>
</li>
</ul>
<h3>准备材料</h3>
<ul>
<li>通畅的全球互联网</li>
<li>一个可用的 AWS 账号</li>
<li>
<p>根据<a href="https://github.com/serverless/serverless#quick-start"> Serverless CLI 文档</a>完成前两步</p>
<ul>
<li><code class="language-text">npm install -g serverless</code></li>
<li><a href="https://github.com/serverless/serverless/blob/master/docs/providers/aws/guide/credentials.md">设置 AWS Credentials </a></li>
</ul>
</li>
</ul>
<h3>创建工程</h3>
<blockquote>
<p>我们选择的语言是 JavaScript ，数据库是 AWS 提供的 DynamoDb ，从 Serverless CLI 的示例库中很快可以找到这样的模版 <a href="https://github.com/serverless/examples/tree/master/aws-node-rest-api-with-dynamodb">aws-node-rest-api-with-dynamodb</a></p>
</blockquote>
<p>复制模版至本地作为起步工程</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">serverless <span class="token function">install</span> -u https://github.com/serverless/examples/tree/master/aws-node-rest-api-with-dynamodb</code></pre></div>
<p>这个工程包含了一个 Todo 列表的 CRUD 操作服务。核心文件有：</p>
<ul>
<li><code class="language-text">serverless.yml</code> 定义了该服务所提供的 <code class="language-text">Lambda 函数</code> 、触发函数的 <code class="language-text">触发器</code> 以及运行该函数所需要的其他 <code class="language-text">AWS 资源</code> 。</li>
<li><code class="language-text">package.json</code> 定义了该服务所依赖的其他库。</li>
<li>
<p><code class="language-text">todos</code> 目录下包含了所有的函数文件。我们可以看到函数都是较为直白的，每一个文件都是类似以下的结构：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">AWS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'aws-sdk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 引入 AWS SDK</span>
<span class="token keyword">const</span> dynamoDb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWS<span class="token punctuation">.</span>DynamoDB<span class="token punctuation">.</span>DocumentClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建 dynamoDb 实例</span>

<span class="token comment">// 通过 module.exports 来导出该函数</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>create <span class="token operator">=</span> <span class="token punctuation">(</span>
  event<span class="token punctuation">,</span> <span class="token comment">// event 对象包含了关于触发该函数事件的信息，每个触发事件 event 包含的信息都会有所不同，具体可参阅文档</span>
  context<span class="token punctuation">,</span> <span class="token comment">// context 对象包含了有关函数调用、执行环境等信息，具体可参阅文档</span>
  callback <span class="token comment">// callback 是一个方法，通过调用 callback 可以在非异步函数中发送响应信息，关于如何定义异步函数与在异步函数内如何发送响应信息可参阅文档</span>
<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析 event 来获得 http 请求参数</span>
  <span class="token comment">/*
  业务逻辑
  */</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用提供的 callback 函数来发送响应信息</span>
<span class="token punctuation">}</span></code></pre></div>
<blockquote>
<p>相关文档：<a href="https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/lambda-services.html">event 文档</a>, <a href="https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/nodejs-prog-model-context.html">context 文档</a>, <a href="https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/nodejs-prog-model-handler.html">定义异步函数</a></p>
</blockquote>
</li>
</ul>
<p>当我们运行 <code class="language-text">npm install</code> 与 <code class="language-text">serverless deploy</code> 将该起步工程部署到云端后，就可以通过 API 地址（例：<a href="https://xxxxxx.execute-api.us-east-1.amazonaws.com/dev/todos">https://xxxxxx.execute-api.us-east-1.amazonaws.com/dev/todos</a>）来运行和访问这些函数。</p>
<h3>创建与定义函数</h3>
<p>根据这个工程原有的函数 ，创建类似的函数文件并非难事，我们在工程中创建以下 4 个文件：</p>
<ul>
<li>user/signup.js</li>
<li>user/login.js</li>
<li>user/public.js</li>
<li>user/private.js</li>
</ul>
<p>但仅仅创建函数文件是不够的，我们需要同时在 <code class="language-text">serverless.yml</code> 中为这几个函数添加定义。以 <code class="language-text">signup</code> 函数为例，在 <code class="language-text">functions</code> 中添加以下内容：</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">signup</span><span class="token punctuation">:</span>
  <span class="token key atrule">handler</span><span class="token punctuation">:</span> user/signup.signup <span class="token comment">#定义了函数文件的路径</span>
  <span class="token key atrule">events</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">http</span><span class="token punctuation">:</span> <span class="token comment">#定义了函数触发器种类为 http (AWS API Gateway)</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> api/user/signup <span class="token comment">#定义了请求路径</span>
        <span class="token key atrule">method</span><span class="token punctuation">:</span> post <span class="token comment">#定义了请求 method 种类</span>
        <span class="token key atrule">cors</span><span class="token punctuation">:</span> <span class="token boolean important">true </span><span class="token comment">#开启跨域</span></code></pre></div>
<p>这样我们就完整地定义了 4 个函数。接下来我们来看这四个函数具体的实现方法。</p>
<h3>Public 函数</h3>
<blockquote>
<p><code class="language-text">GET</code></p>
</blockquote>
<blockquote>
<p>返回一条无须登录即可访问的信息</p>
</blockquote>
<h4>1. 返回消息</h4>
<p> <code class="language-text">public</code> 函数是 4 个函数中最为简易的一个，因为该函数是完全公开的，我们不需要对该函数做任何校验。如下，简单地返回一条信息便可：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// user/public.js</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">public</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token punctuation">{</span>
    statusCode<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token string">'任何人都可以阅读此条信息。'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<blockquote>
<p>注：<code class="language-text">callback</code> 第一个参数传入的为错误，第二个参数传入的为响应数据。</p>
</blockquote>
<h4>2. 部署及访问服务</h4>
<ul>
<li>
<p>执行以下命令来部署 <code class="language-text">public</code> 函数</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 部署单个函数</span>
serverless deploy <span class="token keyword">function</span> -f public</code></pre></div>
<p>或</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 部署所有函数</span>
serverless deploy</code></pre></div>
</li>
<li>
<p>在浏览器中直接输入 API 地址或用 cURL 工具执行以下命令来发送请求（替换成你的 API 地址， API 地址可在运行 <code class="language-text">serverless deploy</code> 后的 <code class="language-text">log</code> 中或在 <code class="language-text">AWS API Gateway控制台</code> - <code class="language-text">阶段（stage）</code> 中找到）</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">curl -X GET https://xxxxxx.execute-api.us-west-2.amazonaws.com/dev/api/public</code></pre></div>
</li>
<li>
<p>返回数据</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"任何人都可以阅读此条信息。"</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
</ul>
<h3>Sign up 函数</h3>
<blockquote>
<p><code class="language-text">POST</code></p>
</blockquote>
<blockquote>
<p>创建一个新用户并录入数据库，返回成功或失败信息</p>
</blockquote>
<h4>1. 定义资源</h4>
<p> <code class="language-text">signup</code> 函数的运行需要 <code class="language-text">DynamoDB</code> 这一资源，所以第一步我们需要在 <code class="language-text">serverless.yml</code> 文件中对 <code class="language-text">resources</code> 进行如下修改来添加所需要的数据库资源</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token comment"># serverless.yml</span>
<span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">Resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">UserDynamoDbTable</span><span class="token punctuation">:</span>
      <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">'AWS::DynamoDB::Table'</span> <span class="token comment">#资源种类为 DynamoDB 表</span>
      <span class="token key atrule">DeletionPolicy</span><span class="token punctuation">:</span> Retain <span class="token comment">#当删除 CloudFormation Stack（serverless remove）时保留该表</span>
      <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">AttributeDefinitions</span><span class="token punctuation">:</span> <span class="token comment">#定义表的属性</span>
          <span class="token punctuation">-</span>
            <span class="token key atrule">AttributeName</span><span class="token punctuation">:</span> username <span class="token comment">#属性名</span>
            <span class="token key atrule">AttributeType</span><span class="token punctuation">:</span> S <span class="token comment">#属性类型为字符串</span>
        <span class="token key atrule">KeySchema</span><span class="token punctuation">:</span> <span class="token comment">#描述表的主键</span>
          <span class="token punctuation">-</span>
            <span class="token key atrule">AttributeName</span><span class="token punctuation">:</span> username <span class="token comment">#键对应的属性名</span>
            <span class="token key atrule">KeyType</span><span class="token punctuation">:</span> HASH <span class="token comment">#键类型为哈希</span>
        <span class="token key atrule">ProvisionedThroughput</span><span class="token punctuation">:</span> <span class="token comment">#表的预置吞吐量</span>
          <span class="token key atrule">ReadCapacityUnits</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment">#读取量为 1 单元</span>
          <span class="token key atrule">WriteCapacityUnits</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment">#写入量为 1 单元</span>
        <span class="token key atrule">TableName</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>self<span class="token punctuation">:</span>provider.environment.DYNAMODB_TABLE<span class="token punctuation">}</span> <span class="token comment"># 定义表名为环境变量中的 DYNAMODB_TABLE</span></code></pre></div>
<blockquote>
<p><code class="language-text">resources</code> 一栏中填写的内容是使用 <code class="language-text">yaml</code> 语法写的 <a href="https://aws.amazon.com/cn/cloudformation/aws-cloudformation-templates/">AWS CloudFormation 的模版</a> 。</p>
</blockquote>
<blockquote>
<p>DynamoDB 表在 CloudFormation 中更为详细定义文档请参考 <a href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-resource-dynamodb-table.html">链接</a> 。</p>
</blockquote>
<h4>2. 获取请求数据</h4>
<p> <code class="language-text">signup</code> 是一个方法为 <code class="language-text">POST</code> 的接口，因此需要从 http 事件的 <code class="language-text">body</code> 中获取请求数据。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// user/signup.js</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">signup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取请求数据并解析 JSON 字符串</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
  <span class="token comment">/*
    ...
    校验 username 与 password
  */</span>
<span class="token punctuation">}</span></code></pre></div>
<h4>3. 录入用户至 DynamoDB</h4>
<p>获取完了请求数据后，我们需要构造出新用户的数据，并把数据录入 DynamoDB</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// user/signup.js</span>
<span class="token comment">// 引入 NodeJS 加密库</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 创建 dynamoDB 实例</span>
<span class="token keyword">const</span> <span class="token constant">AWS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'aws-sdk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> dynamoDb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWS<span class="token punctuation">.</span>DynamoDB<span class="token punctuation">.</span>DocumentClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">signup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...获取并校验 username 与 password</span>
  
  <span class="token comment">// 生成 salt 来确保哈希后密码的唯一性</span>
  <span class="token keyword">const</span> salt <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 用 sha512 哈希函数加密，生成仅可单向验证的哈希密码</span>
  <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">pbkdf2Sync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token string">'sha512'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> timestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成当前时间戳</span>
  <span class="token comment">// 生成新用户的数据</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
    TableName<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DYNAMODB_TABLE</span><span class="token punctuation">,</span> <span class="token comment">// 从环境变量中获取 DynamoDB 表名</span>
    Item<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      username<span class="token punctuation">,</span> <span class="token comment">// 用户名</span>
      salt<span class="token punctuation">,</span> <span class="token comment">// 保存 salt 用于登录时单向校验密码</span>
      password<span class="token punctuation">:</span> hashedPassword<span class="token punctuation">,</span> <span class="token comment">// 哈希密码</span>
      createdAt<span class="token punctuation">:</span> timestamp<span class="token punctuation">,</span> <span class="token comment">// 生成时间</span>
      updatedAt<span class="token punctuation">:</span> timestamp <span class="token comment">// 更新时间</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 将新用户数据录入至 dynamoDb</span>
  dynamoDb<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回失败信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// log 错误信息，可在 AWS CloudWatch 服务中查看</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        statusCode<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          message<span class="token punctuation">:</span> <span class="token string">'创建用户失败！'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 返回成功信息</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        statusCode<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          message<span class="token punctuation">:</span> <span class="token string">'创建用户成功！'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<blockquote>
<p>DynamoDB 在 NodeJS 中更详细的 CRUD 操作文档请参考<a href="https://docs.aws.amazon.com/zh_cn/amazondynamodb/latest/developerguide/GettingStarted.NodeJs.03.html">链接</a></p>
</blockquote>
<h4>4. 部署及访问服务</h4>
<ul>
<li>
<p>执行以下命令来部署 <code class="language-text">signup</code> 函数</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 部署单个函数</span>
serverless deploy <span class="token keyword">function</span> -f signup</code></pre></div>
<p>或</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 部署所有函数</span>
serverless deploy</code></pre></div>
</li>
<li>
<p>用 <code class="language-text">cURL</code> 工具执行以下命令来发送请求（替换成你的API地址，API地址可在运行 <code class="language-text">serverless deploy</code> 后的 log 中或在 <code class="language-text">AWS API Gateway控制台</code> - <code class="language-text">阶段（stage）</code> 中找到）</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">curl -X POST https://xxxxxx.execute-api.us-west-2.amazonaws.com/dev/api/user/signup --data &#39;{ &quot;username&quot;: &quot;new_user&quot;, &quot;password&quot;: &quot;12345678&quot; }&#39;</code></pre></div>
</li>
<li>
<p>返回数据</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"创建用户成功！"</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
</ul>
<h3>Login 函数</h3>
<blockquote>
<p><code class="language-text">GET</code></p>
</blockquote>
<blockquote>
<p>校验用户名密码并返回 JSON Web Token 来让登录用户访问私有接口</p>
</blockquote>
<h4>1. 设置 JSON Web Token</h4>
<p>在用户调用了 Login 接口并通过验证后，我们需要为用户返回一个 <code class="language-text">JSON Web Token</code> ，以供用户来调用需要权限的服务。设置 JSON Web Token 需要以下几步操作：</p>
<ul>
<li><code class="language-text">npm install jsonwebtoken --save</code> 安装 <code class="language-text">jsonwebtoken</code> 库并添加至项目依赖</li>
<li>
<p>在项目中添加一个 <code class="language-text">secret.json</code> 文件来存放密钥，这里我们采用对称加密的方式来定义一个私有密钥。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// secret.json</span>
<span class="token punctuation">{</span>
  <span class="token string">"secret"</span><span class="token punctuation">:</span> <span class="token string">"私有密钥"</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p>将私有密钥定义至环境变量，以供函数访问。在 <code class="language-text">serverless.yml</code> 的 <code class="language-text">provider</code> 下作如下变更</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token comment"># serverless.yml</span>
<span class="token key atrule">provider</span><span class="token punctuation">:</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span>
    <span class="token comment"># 使用serverless变量语法将文件中的密钥赋值给环境变量PRIVATE_KEY</span>
    <span class="token key atrule">PRIVATE_KEY</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>file(./secret.json)<span class="token punctuation">:</span>secret<span class="token punctuation">}</span></code></pre></div>
</li>
</ul>
<h4>2. 获取请求数据</h4>
<p> <code class="language-text">login</code> 是一个方法为 <code class="language-text">GET</code> 的接口，因此需要从触发事件的 <code class="language-text">queryStringParameters</code> 中获取请求数据。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// user/login.js</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取请求数据</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">.</span>queryStringParameters<span class="token punctuation">;</span>
  <span class="token comment">/*
    ...
    校验 username 与 password
  */</span>
<span class="token punctuation">}</span></code></pre></div>
<h4>3. 验证账号密码并返回 JSON Web Token</h4>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// user/login.js</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">AWS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'aws-sdk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dynamoDb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWS<span class="token punctuation">.</span>DynamoDB<span class="token punctuation">.</span>DocumentClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...获取并校验 username 与 password</span>
  
  <span class="token comment">// 验证账号密码并返回 JSON Web Token</span>
  
  <span class="token comment">// 构造 DynamoDB 请求数据，根据主键 username 获取数据</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
    TableName<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DYNAMODB_TABLE</span><span class="token punctuation">,</span>
    Key<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      username
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 从 DynamoDB 中获取数据</span>
  dynamoDb<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// log 错误信息，可在 AWS CloudWatch 服务中查看</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 返回错误信息</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        statusCode<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          message<span class="token punctuation">:</span> <span class="token string">'登录失败！'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 从回调参数中获取 DynamoDB 返回的用户数据</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> data<span class="token punctuation">.</span>Item<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token comment">// 确认 username 存在</span>
      user <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// 确认哈希密码匹配</span>
      user<span class="token punctuation">.</span>password <span class="token operator">===</span> crypto<span class="token punctuation">.</span><span class="token function">pbkdf2Sync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>salt<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token string">'sha512'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 返回登录成功信息</span>
      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token punctuation">{</span>
        statusCode<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          username<span class="token punctuation">,</span> <span class="token comment">// 返回 username</span>
          <span class="token comment">// 返回 JSON Web Token</span>
          token<span class="token punctuation">:</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>
            <span class="token punctuation">{</span>
              username <span class="token comment">// 嵌入 username 数据</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PRIVATE_KEY</span> <span class="token comment">// 使用环境变量中的私有密钥签发 token</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当用户不存在，以及用户密码校验错误时返回错误信息</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        statusCode<span class="token punctuation">:</span> <span class="token number">401</span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          message<span class="token punctuation">:</span> <span class="token string">'用户名或密码错误！'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<h4>4. 部署及访问服务</h4>
<ul>
<li>
<p>执行以下命令来部署 <code class="language-text">login</code> 函数</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 部署单个函数</span>
serverless deploy <span class="token keyword">function</span> -f login</code></pre></div>
<p>或</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 部署所有函数</span>
serverless deploy</code></pre></div>
</li>
<li>
<p>在浏览器中直接输入 API 地址或用 cURL 工具执行以下命令来发送请求（替换成你的 API 地址， API 地址可在运行 <code class="language-text">serverless deploy</code> 后的log中或在 <code class="language-text">AWS API Gateway控制台</code> - <code class="language-text">阶段（stage）</code> 中找到）</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">curl -X GET &#39;https://xxxxxx.execute-api.us-west-2.amazonaws.com/dev/api/user/login?username=new_user&amp;password=12345678&#39;</code></pre></div>
</li>
<li>
<p>返回数据</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"token"</span><span class="token operator">:</span> <span class="token string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Im5ld191c2VyIiwiaWF0IjoxNTYxODI1NTgyfQ.Iv0ulooGayulxf_MkkpBO1xEw1gilThT62ysuz-rQE0"</span><span class="token punctuation">,</span>
  <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"new_user"</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
</ul>
<h3>Auth 函数</h3>
<blockquote>
<p>校验请求中所包含的 JSON Web Token 是否有效</p>
</blockquote>
<p>在编写 <code class="language-text">private</code> 函数之前，我们需要提供另一个函数 <code class="language-text">auth</code> 来校验用户提交请求中的 JSON Web Token 是否与我们所签发的一致。</p>
<h4>1. 创建函数</h4>
<ul>
<li>在项目中添加 <code class="language-text">user/auth.js</code> 文件</li>
<li>
<p>在 <code class="language-text">serverless.yml</code> 的 <code class="language-text">functions</code> 中添加以下内容：</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">auth</span><span class="token punctuation">:</span>
<span class="token key atrule">handler</span><span class="token punctuation">:</span> user/auth.auth
<span class="token comment"># auth 是一个仅会在服务内被调用的函数，因此没有任何触发器</span></code></pre></div>
</li>
</ul>
<h4>2. 生成包含 IAM 权限策略的响应信息</h4>
<p>为了能够让 <code class="language-text">AWS API Gateway</code> 触发器正确地识别函数有无权限执行，我们必须在 <code class="language-text">auth</code> 函数中返回一个含 IAM （ AWS 服务与权限管控系统） 权限策略信息的响应数据，来使得有权限的函数可以通过 <code class="language-text">AWS API Gateway</code> 成功触发。在 <code class="language-text">user/auth.js</code> 内定义一个如下的方法：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// user/auth.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">generatePolicy</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">principalId<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> resource</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> authResponse <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  authResponse<span class="token punctuation">.</span>principalId <span class="token operator">=</span> principalId<span class="token punctuation">;</span> <span class="token comment">// 用于标记用户身份信息</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effect <span class="token operator">&amp;&amp;</span> resource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> policyDocument <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    policyDocument<span class="token punctuation">.</span>Version <span class="token operator">=</span> <span class="token string">'2012-10-17'</span><span class="token punctuation">;</span> <span class="token comment">// 定义版本信息</span>
    policyDocument<span class="token punctuation">.</span>Statement <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> statementOne <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    statementOne<span class="token punctuation">.</span>Action <span class="token operator">=</span> <span class="token string">'execute-api:Invoke'</span><span class="token punctuation">;</span> <span class="token comment">// 定义操作类型，这里为 API 调用操作</span>
    statementOne<span class="token punctuation">.</span>Effect <span class="token operator">=</span> effect<span class="token punctuation">;</span> <span class="token comment">// 可用值为 ALLOW 或 DENY ，用于指定该策略所产生的结果是允许还是拒绝</span>
    statementOne<span class="token punctuation">.</span>Resource <span class="token operator">=</span> resource<span class="token punctuation">;</span> <span class="token comment">// 传入 ARN（ AWS 资源名）来指定操作所需要的资源</span>
    policyDocument<span class="token punctuation">.</span>Statement<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> statementOne<span class="token punctuation">;</span>
    authResponse<span class="token punctuation">.</span>policyDocument <span class="token operator">=</span> policyDocument<span class="token punctuation">;</span> <span class="token comment">// 将定义完成的策略加入响应数据</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> authResponse<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<blockquote>
<p>关于 IAM 策略更为详细的配置文档请查看<a href="https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/reference_policies_elements.html">链接</a></p>
</blockquote>
<h4>3. 解析并校验 JSON Web Token</h4>
<p>我们在解析 JSON Web Token 时默认请求遵循 OAuth2.0 中的 Bearer Token 格式。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// user/auth.js</span>
<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 
  ...定义 generatePolicy 方法
*/</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">auth</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取请求头中的 Authorization</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> authorizationToken <span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>authorizationToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解析 Authorization</span>
    <span class="token keyword">const</span> split <span class="token operator">=</span> event<span class="token punctuation">.</span>authorizationToken<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'Bearer'</span> <span class="token operator">&amp;&amp;</span> split<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用私有密钥校验 JSON Web Token</span>
        <span class="token keyword">const</span> decoded <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PRIVATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用 generatePolicy 生成包含允许API调用的IAM权限策略的响应数据</span>
        <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token function">generatePolicy</span><span class="token punctuation">(</span>decoded<span class="token punctuation">.</span>username<span class="token punctuation">,</span> <span class="token string">'Allow'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>methodArn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// JSON Web Token 校验失败，返回错误</span>
        <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">'Unauthorized'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Authorization 格式校验失败，返回错误</span>
      <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">'Unauthorized'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求头未含 Authorzation，返回错误</span>
    <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">'Unauthorized'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<h3>Private 函数</h3>
<blockquote>
<p><code class="language-text">GET</code></p>
</blockquote>
<blockquote>
<p>返回一条需要登录才可访问的信息</p>
</blockquote>
<p> <code class="language-text">private</code> 函数的实现与之前的 <code class="language-text">public</code> 函数十分类似，唯一的区别就是我们需要在函数的 <code class="language-text">http (AWS API Gateway)</code> 触发器中加入刚刚定义的 <code class="language-text">auth</code> 作为权限校验函数。</p>
<h4>1. 设置 authorizer</h4>
<p>在 <code class="language-text">serverless.yml</code> 中对先前定义的 <code class="language-text">private</code> 函数作如下变更：</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token comment"># serverless.yml</span>
<span class="token key atrule">functions</span><span class="token punctuation">:</span> 
  <span class="token key atrule">private</span><span class="token punctuation">:</span>
    <span class="token key atrule">handler</span><span class="token punctuation">:</span> user/private.private
    <span class="token key atrule">events</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> api/private
        <span class="token key atrule">method</span><span class="token punctuation">:</span> get
        <span class="token key atrule">authorizer</span><span class="token punctuation">:</span> auth <span class="token comment">#设置 authorizer 为刚刚定义的 auth 函数</span>
        <span class="token key atrule">cors</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre></div>
<h4>2. 返回消息</h4>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// user/private.js</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">private</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 从触发事件中获取请求的用户信息</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> event<span class="token punctuation">.</span>requestContext<span class="token punctuation">.</span>authorizer<span class="token punctuation">.</span>principalId<span class="token punctuation">;</span>
  <span class="token comment">// 返回消息</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token punctuation">{</span>
    statusCode<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">你好，</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">！只有登录后的用户才可以阅读此条信息。</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<h4>3. 部署及访问服务</h4>
<ul>
<li>
<p>执行以下命令来部署 <code class="language-text">private</code> 函数</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 部署单个函数</span>
serverless deploy <span class="token keyword">function</span> -f private</code></pre></div>
<p>或</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 部署所有函数</span>
serverless deploy</code></pre></div>
</li>
<li>
<p>用 cURL 工具执行以下命令来发送请求（替换成你的 API 地址， API 地址可在运行 <code class="language-text">serverless deploy</code> 后的 log 中或在 <code class="language-text">AWS API Gateway控制台</code> - <code class="language-text">阶段（stage）</code> 中找到）</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">curl -X GET -H &quot;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Im5ld191c2VyIiwiaWF0IjoxNTYxODI1NTgyfQ.Iv0ulooGayulxf_MkkpBO1xEw1gilThT62ysuz-rQE0&quot; https://xxxxxx.execute-api.us-west-2.amazonaws.com/dev/api/private</code></pre></div>
</li>
<li>
<p>返回数据</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"你好，new_user！只有登录后的用户才可以阅读此条信息。"</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
</ul>
<h3>实践小结</h3>
<h4>用了什么？</h4>
<ul>
<li>Serverless CLI</li>
<li>AWS Lambda</li>
<li>AWS API Gateway</li>
<li>AWS CloudWatch</li>
<li>DynamoDB</li>
<li>OAuth2.0</li>
</ul>
<h4>做了什么？</h4>
<ul>
<li>使用 Serverless 开发与部署了一套 HTTP 接口服务</li>
<li>服务提供了用户的注册、登录接口</li>
<li>服务提供了完全开放接口与仅登录用户可访问接口</li>
</ul>
<h4>完整工程</h4>
<p>如果在教程中有疑点，可以在 <a href="https://github.com/yuanfux/aws-lambda-user">Github</a> 上查看完整的代码。</p>
<h3>引用</h3>
<ul>
<li><a href="https://mikhail.io/serverless/coldstarts/aws/">Cold Starts in AWS Lambda</a></li>
<li><a href="https://medium.com/@amiram_26122/the-hidden-costs-of-serverless-6ced7844780b">The hidden costs of serverless</a></li>
</ul>
<blockquote>
<p>本文发布自 <a href="https://github.com/x-orpheus">网易云音乐前端团队</a>，文章未经授权禁止任何形式的转载。我们一直在招人，如果你恰好准备换工作，又恰好喜欢云音乐，那就 <a href="mailto:grp.music-fe@corp.netease.com">加入我们</a>！</p>
</blockquote></section><hr style="margin-bottom:1.625rem"/></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/javascript-functional-programming-quickstart/">← 上一篇</a></li><li><a rel="next" href="/web-audio-visualization/">下一篇 →</a></li></ul></nav><div id="disqus_thread"></div></main></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-46698359-8', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/aws-serverless/";window.webpackCompilationHash="95f1de1856b8b6766301";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-0c9a63a3aef9e813df5b.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-51d272fe0618a2665c13.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-788c454dbed28c00f3b8.js"],"component---src-pages-404-js":["/component---src-pages-404-js-e9fc057fd683384561c6.js"],"component---src-pages-index-js":["/component---src-pages-index-js-48dc264068dece189e1b.js"]};/*]]>*/</script><script src="/webpack-runtime-2742ada98d46151d1c6f.js" async=""></script><script src="/commons-8d9941e7328683a5eecb.js" async=""></script><script src="/app-0c9a63a3aef9e813df5b.js" async=""></script><script src="/component---src-templates-blog-post-js-788c454dbed28c00f3b8.js" async=""></script><script src="/styles-ad8e7b79adaf3a577ea0.js" async=""></script></body></html>