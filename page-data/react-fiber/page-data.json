{"componentChunkName":"component---src-templates-blog-post-js","path":"/react-fiber/","webpackCompilationHash":"a328ffc1161c667df4f7","result":{"data":{"site":{"siteMetadata":{"title":"云音乐大前端专栏","author":"云音乐大前端团队","siteUrl":"https://musicfe.dev"}},"markdownRemark":{"id":"4367616d-23d7-58f2-8553-84803dd796a6","excerpt":"图片作者：Artem Sapegin，来源：https://unsplash.com/photos/b18TRXc8UPQ 本文作者：刘鹏 前言 在 React v16.13 版本中，正式推出了实验性的 Concurrent Mode，尤其是提供一种新的机制 Suspense…","html":"<p><img src=\"https://p1.music.126.net/gQ7CYdQbSwu1fgzirR2_8w==/109951165101159309.jpg\"></p>\n<blockquote>\n<p>图片作者：Artem Sapegin，来源：<a href=\"https://unsplash.com/photos/b18TRXc8UPQ\">https://unsplash.com/photos/b18TRXc8UPQ</a></p>\n</blockquote>\n<blockquote>\n<p>本文作者：刘鹏</p>\n</blockquote>\n<h2>前言</h2>\n<p>在 React v16.13 版本中，正式推出了实验性的 Concurrent Mode，尤其是提供一种新的机制 Suspense，非常自然地解决了一直以来存在的异步副作用问题。结合前面 v16.8 推出的 Hooks，v16.0 底层架构 Fiber，React 给开发者体验上带来了极大提升以及一定程度上更佳的用户体验。所以，对 React 17，你会有什么期待？</p>\n<h2>Stack Reconciler 和  Fiber Reconciler</h2>\n<p>我们知道，Stack Reconciler 是 React v15 及之前版本使用的协调算法。而 React Fiber 则是从 v16 版本开始对 Stack Reconciler 进行的重写，是 v16 版本的核心算法实现。\nStack Reconciler 的实现使用了同步递归模型，该模型依赖于内置堆栈来遍历。React 团队 Andrew 之前有提到：</p>\n<blockquote>\n<p>如果只依赖内置调用堆栈，那么它将一直工作，直到堆栈为空，如果我们可以随意中断调用堆栈并手动操作堆栈帧，这不是很好吗? 这就是 React Fiber 的目标。Fiber 是内置堆栈的重新实现，专门用于 React 组件，可以将一个 fiber 看作是一个虚拟堆栈帧。</p>\n</blockquote>\n<p>正是由于其内置 Stack Reconciler 天生带来的局限性，使得 DOM 更新过程是同步的。也就是说，在虚拟 DOM 的比对过程中，如果发现一个元素实例有更新，则会立即同步执行操作，提交到真实 DOM 的更改。这在动画、布局以及手势等领域，可能会带来非常糟糕的用户体验。因此，为了解决这个问题，React 实现了一个虚拟堆栈帧。实际上，这个所谓的虚拟堆栈帧本质上是建立了多个包含节点和指针的链表数据结构。每一个节点就是一个 fiber 基本单元，这个对象存储了一定的组件相关的数据域信息。而指针的指向，则是串联起整个 fibers 树。重新自定义堆栈带来显而易见的优点是，可以将堆栈保留在内存中，在需要执行的时候执行它们，这使得暂停遍历和停止堆栈递归成为可能。</p>\n<p>Fiber 的主要目标是实现虚拟 DOM 的增量渲染，能够将渲染工作拆分成块并将其分散到多个帧的能力。在新的更新到来时，能够暂停、中止和复用工作，能为不同类型的更新分配优先级顺序的能力。理解 React 运行机制对我们更好理解它的设计思想以及后续版本新增特性，比如 v17 版本可能带来的异步渲染能力，相信会有很好的帮助。本文基于 React v16.8.6 版本源码，输出一些浅见，希望对你也有帮助，如有不对，还望指正。</p>\n<h2>基础概念</h2>\n<p>在了解 React Fiber 架构的实现机制之前，有必要先把几个主要的基础概念抛出来，以便于我们更好地理解。</p>\n<h3>Work</h3>\n<p>在 React Reconciliation 过程中出现的各种必须执行计算的活动，比如 state update，props update 或 refs update 等，这些活动我们可以统一称之为 work。</p>\n<h3>Fiber 对象</h3>\n<blockquote>\n<p>文件位置：packages/react-reconciler/src/ReactFiber.js</p>\n</blockquote>\n<p>每一个 React 元素对应一个 fiber 对象，一个 fiber 对象通常是表征 work 的一个基本单元。fiber 对象有几个属性，这些属性指向其他 fiber 对象。</p>\n<ul>\n<li>child： 对应于父 fiber 节点的子 fiber</li>\n<li>sibling： 对应于 fiber 节点的同类兄弟节点</li>\n<li>return： 对应于子 fiber 节点的父节点</li>\n</ul>\n<p>因此 fibers 可以理解为是一个包含 React 元素上下文信息的数据域节点，以及由 child, sibling 和 return 等指针域构成的链表结构。</p>\n<p>fiber 对象主要的属性如下所示：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Fiber <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 标识 fiber 类型的标签，详情参看下述 WorkTag</span>\n    tag<span class=\"token punctuation\">:</span> WorkTag<span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// 指向父节点</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// 指向子节点</span>\n    child<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// 指向兄弟节点</span>\n    sibling<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// 在开始执行时设置 props 值</span>\n    pendingProps<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// 在结束时设置的 props 值</span>\n    memoizedProps<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// 当前 state</span>\n    memoizedState<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// Effect 类型，详情查看以下 effectTag</span>\n    effectTag<span class=\"token punctuation\">:</span> SideEffectTag<span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// effect 节点指针，指向下一个 effect</span>\n    nextEffect<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// effect list 是单向链表，第一个 effect</span>\n    firstEffect<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// effect list 是单向链表，最后一个 effect</span>\n    lastEffect<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// work 的过期时间，可用于标识一个 work 优先级顺序</span>\n    expirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>从 React 元素创建一个 fiber 对象</p>\n<blockquote>\n<p>文件位置：react-reconciler/src/ReactFiber.js</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createFiberFromElement</span><span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\">element<span class=\"token punctuation\">:</span> ReactElement<span class=\"token punctuation\">,</span>\n    mode<span class=\"token punctuation\">:</span> TypeOfMode<span class=\"token punctuation\">,</span>\n    expirationTime<span class=\"token punctuation\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> fiber <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromTypeAndProps</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> pendingProps<span class=\"token punctuation\">,</span> owner<span class=\"token punctuation\">,</span> mode<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>workTag</h3>\n<blockquote>\n<p>文件位置：shared/ReactWorkTags.js</p>\n</blockquote>\n<p>上述 fiber 对象的 tag 属性值，称作 workTag，用于标识一个 React 元素的类型，如下所示：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> FunctionComponent <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> ClassComponent <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> IndeterminateComponent <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Before we know whether it is function or class</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> HostRoot <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Root of a host tree. Could be nested inside another node.</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> HostPortal <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// A subtree. Could be an entry point to a different renderer.</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> HostComponent <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> HostText <span class=\"token operator\">=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Fragment <span class=\"token operator\">=</span> <span class=\"token number\">7</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Mode <span class=\"token operator\">=</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> ContextConsumer <span class=\"token operator\">=</span> <span class=\"token number\">9</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> ContextProvider <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> ForwardRef <span class=\"token operator\">=</span> <span class=\"token number\">11</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Profiler <span class=\"token operator\">=</span> <span class=\"token number\">12</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> SuspenseComponent <span class=\"token operator\">=</span> <span class=\"token number\">13</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> MemoComponent <span class=\"token operator\">=</span> <span class=\"token number\">14</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> SimpleMemoComponent <span class=\"token operator\">=</span> <span class=\"token number\">15</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> LazyComponent <span class=\"token operator\">=</span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> IncompleteClassComponent <span class=\"token operator\">=</span> <span class=\"token number\">17</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> DehydratedSuspenseComponent <span class=\"token operator\">=</span> <span class=\"token number\">18</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> EventComponent <span class=\"token operator\">=</span> <span class=\"token number\">19</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> EventTarget <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> SuspenseListComponent <span class=\"token operator\">=</span> <span class=\"token number\">21</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>EffectTag</h3>\n<blockquote>\n<p>文件位置：shared/ReactSideEffectTags.js</p>\n</blockquote>\n<p>上述 fiber 对象的 effectTag 属性值，每一个 fiber 节点都有一个和它相关联的 effectTag 值。<br>\n我们把不能在 render 阶段完成的一些 work 称之为副作用，React 罗列了可能存在的各类副作用，如下所示：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> NoEffect <span class=\"token operator\">=</span> <span class=\"token comment\">/*              */</span> <span class=\"token number\">0b000000000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> PerformedWork <span class=\"token operator\">=</span> <span class=\"token comment\">/*         */</span> <span class=\"token number\">0b000000000001</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Placement <span class=\"token operator\">=</span> <span class=\"token comment\">/*             */</span> <span class=\"token number\">0b000000000010</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Update <span class=\"token operator\">=</span> <span class=\"token comment\">/*                */</span> <span class=\"token number\">0b000000000100</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> PlacementAndUpdate <span class=\"token operator\">=</span> <span class=\"token comment\">/*    */</span> <span class=\"token number\">0b000000000110</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Deletion <span class=\"token operator\">=</span> <span class=\"token comment\">/*              */</span> <span class=\"token number\">0b000000001000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> ContentReset <span class=\"token operator\">=</span> <span class=\"token comment\">/*          */</span> <span class=\"token number\">0b000000010000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Callback <span class=\"token operator\">=</span> <span class=\"token comment\">/*              */</span> <span class=\"token number\">0b000000100000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> DidCapture <span class=\"token operator\">=</span> <span class=\"token comment\">/*            */</span> <span class=\"token number\">0b000001000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Ref <span class=\"token operator\">=</span> <span class=\"token comment\">/*                   */</span> <span class=\"token number\">0b000010000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Snapshot <span class=\"token operator\">=</span> <span class=\"token comment\">/*              */</span> <span class=\"token number\">0b000100000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Passive <span class=\"token operator\">=</span> <span class=\"token comment\">/*               */</span> <span class=\"token number\">0b001000000000</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> LifecycleEffectMask <span class=\"token operator\">=</span> <span class=\"token comment\">/*   */</span> <span class=\"token number\">0b001110100100</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> HostEffectMask <span class=\"token operator\">=</span> <span class=\"token comment\">/*        */</span> <span class=\"token number\">0b001111111111</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Incomplete <span class=\"token operator\">=</span> <span class=\"token comment\">/*            */</span> <span class=\"token number\">0b010000000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> ShouldCapture <span class=\"token operator\">=</span> <span class=\"token comment\">/*         */</span> <span class=\"token number\">0b100000000000</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>Reconciliation 和 Scheduling</h3>\n<p>协调（Reconciliation）：<br>\n简而言之，根据 diff 算法来比较虚拟 DOM，从而可以确认哪些部分的 React 元素需要更改。</p>\n<p>调度（Scheduling）：<br>\n可以简单理解为是一个确定在什么时候执行 work 的过程。</p>\n<h3>Render 阶段和 Commit 阶段</h3>\n<p>相信很多同学都看过这张图，这是 React 团队作者 Dan Abramov 画的一张生命周期阶段图，<a href=\"https://twitter.com/dan_abramov/status/981712092611989509?lang=en\">详情点击查看</a>。他把 React 的生命周期主要分为两个阶段：render 阶段和 commit 阶段。其中 commit 阶段又可以细分为 pre-commit 阶段和 commit 阶段，如下图所示：</p>\n<p><img src=\"https://p1.music.126.net/sxGbXXgh_vcsGIBSpgzUwQ==/109951165071751568.png\" alt=\"image.png\"></p>\n<p>从 v16.3 版本开始，在 render 阶段，以下几个生命周期被认为是不安全的，它们将在未来的版本中被移除，可以看到这些生命周期在上图中未被包括进去，如下所示：</p>\n<ul>\n<li>[UNSAFE_]componentWillMount (deprecated)</li>\n<li>[UNSAFE_]componentWillReceiveProps (deprecated)</li>\n<li>[UNSAFE_]componentWillUpdate (deprecated)</li>\n</ul>\n<p>在 React 官网中明确提到了废弃的原因，这些被标记为不安全的生命周期由于常常被开发者错误理解甚至被滥用，比如一些开发人员会倾向于将带有请求数据等副作用的逻辑放在这些生命周期方法中，认为能带来更好的性能，而实际上真正带来的收益几乎可以忽略。在未来， React 逐步推崇异步渲染模式下，这很有可能会因为不兼容而带来很多问题。</p>\n<p>在 render 阶段，React 可以根据当前可用的时间片处理一个或多个 fiber 节点，并且得益于 fiber 对象中存储的元素上下文信息以及指针域构成的链表结构，使其能够将执行到一半的工作保存在内存的链表中。当 React 停止并完成保存的工作后，让出时间片去处理一些其他优先级更高的事情。之后，在重新获取到可用的时间片后，它能够根据之前保存在内存的上下文信息通过快速遍历的方式找到停止的 fiber 节点并继续工作。由于在此阶段执行的工作并不会导致任何用户可见的更改，因为并没有被提交到真实的 DOM。所以，我们说是 fiber 让调度能够实现暂停、中止以及重新开始等增量渲染的能力。相反，在 commit 阶段，work 执行总是同步的，这是因为在此阶段执行的工作将导致用户可见的更改。这就是为什么在 commit 阶段， React 需要一次性提交并完成这些工作的原因。</p>\n<h3>Current 树和 WorkInProgress 树</h3>\n<p>首次渲染之后，React 会生成一个对应于 UI 渲染的 fiber 树，称之为 current 树。实际上，React 在调用生命周期钩子函数时就是通过判断是否存在 current 来区分何时执行 componentDidMount 和 componentDidUpdate。当 React 遍历 current 树时，它会为每一个存在的 fiber 节点创建了一个替代节点，这些节点构成一个 workInProgress 树。后续所有发生 work 的地方都是在 workInProgress 树中执行，如果该树还未创建，则会创建一个 current 树的副本，作为 workInProgress 树。当 workInProgress 树被提交后将会在 commit 阶段的某一子阶段被替换成为 current 树。</p>\n<p>这里增加两个树的主要原因是为了避免更新的丢失。比如，如果我们只增加更新到 workInProgress 树，当 workInProgress 树通过从 current 树中克隆而重新开始时，一些更新可能会丢失。同样的，如果我们只增加更新到 current 树，当 workInProgress 树被提交后会被替换为 current 树，更新也会被丢失。通过在两个队列都保持更新，可以确保更新始终是下一个 workInProgress 树的一部分。并且，因为 workInProgress 树被提交成为 current 树，并不会出现相同的更新而被重复应用两次的情况。</p>\n<h3>Effects list</h3>\n<p>effect list 可以理解为是一个存储 effectTag 副作用列表容器。它是由 fiber 节点和指针 nextEffect 构成的单链表结构，这其中还包括第一个节点 firstEffect，和最后一个节点 lastEffect。如下图所示：</p>\n<p><img src=\"https://p1.music.126.net/iLgNdiRLxrM0WZGYA1ORAA==/109951165071746326.png\" alt=\"image.png\"></p>\n<p>React 采用深度优先搜索算法，在 render 阶段遍历 fiber 树时，把每一个有副作用的 fiber 筛选出来，最后构建生成一个只带副作用的 effect list 链表。<br>\n在 commit 阶段，React 拿到 effect list 数据后，通过遍历 effect list，并根据每一个 effect 节点的 effectTag 类型，从而对相应的 DOM 树执行更改。</p>\n<p>更多 effect list 构建演示流程，可以点击查看动画 <a href=\"https://www.bilibili.com/video/av48384879/\">《Effect List —— 又一个 Fiber 链表的构建过程》</a>。</p>\n<h2>Render 阶段</h2>\n<p>在本文中，我们以类组件为例，假设已经开始调用了一个 setState 方法。</p>\n<h3>enqueueSetState</h3>\n<p>每个 React 组件都有一个相关联的 updater，作为组件层和核心库之间的桥梁。<br>\nreact.Component 本质上就是一个函数，在它的原型对象上挂载了 setState 方法</p>\n<blockquote>\n<p>文件位置：react/src/ReactBaseClasses.js</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Component函数</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Component</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> updater</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context <span class=\"token operator\">=</span> context<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>updater <span class=\"token operator\">=</span> updater <span class=\"token operator\">||</span> ReactNoopUpdateQueue<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Component原型对象挂载 setState</span>\n<span class=\"token class-name\">Component</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">setState</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">partialState<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>updater<span class=\"token punctuation\">.</span><span class=\"token function\">enqueueSetState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> partialState<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> <span class=\"token string\">'setState'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>React 给 work 大致分成以下几种优先级类型，其中 immediate 比较特殊，它的优先级最高，可以理解为是同步调度，调度过程中不会被中断。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> NoPriority <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> ImmediatePriority <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> UserBlockingPriority <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> NormalPriority <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> LowPriority <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> IdlePriority <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>React 有一套计算逻辑，根据不同的优先级类型为不同的 work 计算出一个过期时间 expirationTime，其实就是一个时间戳。所谓的 React 在新的更新到来时，能为不同类型的更新分配优先级顺序的能力，本质上是根据过期时间 expirationTime 的大小来确定优先级顺序，expirationTime 数值越小，则优先级越高。在相差一定时间范围内的 work，React 会认为它们是同一个批次（batch）的，因此这一批次的 work 会在一次更新中完成。</p>\n<blockquote>\n<p>文件位置：react-reconciler/src/ReactFiberClassComponent.js</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> classComponentUpdater <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">enqueueSetState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">inst<span class=\"token punctuation\">,</span> payload<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 获取 fiber 对象</span>\n        <span class=\"token keyword\">const</span> fiber <span class=\"token operator\">=</span> <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span>inst<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">requestCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 计算到期时间 expirationTime</span>\n        <span class=\"token keyword\">const</span> expirationTime <span class=\"token operator\">=</span> <span class=\"token function\">computeExpirationForFiber</span><span class=\"token punctuation\">(</span>currentTime<span class=\"token punctuation\">,</span> fiber<span class=\"token punctuation\">,</span> suspenseConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">const</span> update <span class=\"token operator\">=</span> <span class=\"token function\">createUpdate</span><span class=\"token punctuation\">(</span>expirationTime<span class=\"token punctuation\">,</span> suspenseConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 插入 update 到队列</span>\n        <span class=\"token function\">enqueueUpdate</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 调度 work 方法</span>\n        <span class=\"token function\">scheduleWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>renderRoot</h3>\n<blockquote>\n<p>文件位置：react-reconciler/src/ReactFiberWorkLoop.js</p>\n</blockquote>\n<p>协调过程总是 renderRoot 开始，方法调用栈：scheduleWork -->  scheduleCallbackForRoot  --> renderRoot</p>\n<p>代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">renderRoot</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">root<span class=\"token punctuation\">:</span> FiberRoot<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span>\n  isSync<span class=\"token punctuation\">:</span> boolean<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 优先级最高，走同步分支</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isSync<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">workLoopSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 所有的fiber节点都在workLoop 中被处理</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">shouldYield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>performUnitOfWork</h3>\n<p>所有的 fiber 节点都在 workLoop 方法处理。协调过程总是从最顶层的 hostRoot 节点开始进行 workInProgress 树的遍历。但是，React 会跳过已经处理过的 fiber 节点，直到找到还未完成工作的节点。例如，如果在组件树的深处调用 setState，React 将从顶部开始，但会快速跳过父节点，直到到达调用了 setState 方法的组件。整个过程采用的是深度优先搜索算法，处理完当前 fiber 节点后，workInProgress 将包含对树中下一个 fiber 节点的引用，如果下一个节点为 null 不存在，则认为执行结束退出 workLoop 循环并准备进行一次提交更改。</p>\n<p>方法调用栈如下：\nperformUnitOfWork  -->  beginWork -->  updateClassComponent --> finishedComponent --> completeUnitOfWork</p>\n<p>代码如下所示：</p>\n<blockquote>\n<p>文件位置：react-reconciler/src/ReactFiberWorkLoop.js</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">unitOfWork<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> unitOfWork<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> next<span class=\"token punctuation\">;</span>\n    next <span class=\"token operator\">=</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> unitOfWork<span class=\"token punctuation\">,</span> renderExpirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 如果没有新的 work，则认为已完成当前工作</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>next <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        next <span class=\"token operator\">=</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span>unitOfWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> next<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>了解树的深度优先搜索算法，可点击参考该示例 <a href=\"https://stackblitz.com/edit/js-ntqfil?file=index.js\">《js-ntqfill》</a>。</p>\n<h3>completeUnitOfWork</h3>\n<blockquote>\n<p>文件位置：react-reconciler/src/completeUnitOfWork.js</p>\n</blockquote>\n<p>在 completeUnitOfWork 方法中构建 effect-list 链表，该 effect list 在下一个 commit 阶段非常重要，关于 effect list 上述有介绍。</p>\n<p>如下所示：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">unitOfWork<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 深度优先搜索算法</span>\n    workInProgress <span class=\"token operator\">=</span> unitOfWork<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> returnFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">/*\n    \t构建 effect-list部分\n    */</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            returnFiber<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>firstEffect<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                returnFiber<span class=\"token punctuation\">.</span>lastEffect<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>firstEffect<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>lastEffect<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            returnFiber<span class=\"token punctuation\">.</span>lastEffect<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            returnFiber<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">const</span> siblingFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>siblingFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// If there is more work to do in this returnFiber, do that next.</span>\n            <span class=\"token keyword\">return</span> siblingFiber<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// Otherwise, return to the parent</span>\n        workInProgress <span class=\"token operator\">=</span> returnFiber<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>至此，一个 render 阶段大概流程结束。</p>\n<h2>Commit 阶段</h2>\n<p>commit 阶段是 React 更新真实 DOM 并调用 pre-commit phase 和 commit phase 生命周期方法的地方。与 render 阶段不同，commit 阶段的执行始终是同步的，它将依赖上一个 render 阶段构建的 effect list 链表来完成。</p>\n<h3>commitRootImpl</h3>\n<p>commit 阶段实质上被分为如下三个子阶段：</p>\n<ul>\n<li>before mutation</li>\n<li>mutation phase</li>\n<li>layout phase</li>\n</ul>\n<p>mutation 阶段主要做的事情是遍历 effect-list 列表，拿到每一个 effect 存储的信息，根据副作用类型 effectTag 执行相应的处理并提交更新到真正的 DOM。所有的 mutation effects 都会在 layout phase 阶段之前被处理。当该阶段执行结束时，workInProgress 树会被替换成 current 树。因此在 mutation phase 阶段之前的子阶段 before mutation，是调用 getSnapshotBeforeUpdate 生命周期的地方。在 before mutation 这个阶段，真正的 DOM 还没有被变更。最后一个子阶段是 layout phase，在这个阶段生命周期 componentDidMount/Update 被执行。</p>\n<blockquote>\n<p>文件位置：react-reconciler/src/ReactFiberWorkLoop.js</p>\n</blockquote>\n<p>如下所示：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitRootImpl</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>firstEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// before mutation 阶段，遍历 effect list</span>\n        <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">commitBeforeMutationEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                nextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// the mutation phase 阶段，遍历 effect list</span>\n        nextEffect <span class=\"token operator\">=</span> firstEffect<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">commitMutationEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                nextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 将 work-in-progress 树替换为 current 树</span>\n        root<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// layout phase 阶段，遍历 effect list</span>\n        nextEffect <span class=\"token operator\">=</span> firstEffect<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">commitLayoutEffects</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">captureCommitPhaseError</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                nextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        nextEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// No effects.</span>\n        root<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>commitBeforeMutationEffects</h3>\n<p>before mutation 调用链路：commitRootImpl -->  commitBeforeMutationEffects --> commitBeforeMutationLifeCycles</p>\n<p>代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitBeforeMutationLifeCycles</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">current<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  finishedWork<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> FunctionComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> ForwardRef<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> SimpleMemoComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token comment\">// 属性 stateNode 表示对应组件的实例</span>\n    <span class=\"token comment\">// 在这里 class 组件实例执行 instance.getSnapshotBeforeUpdate()</span>\n    <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Snapshot<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> prevProps <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedProps<span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">const</span> prevState <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">const</span> snapshot <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span><span class=\"token function\">getSnapshotBeforeUpdate</span><span class=\"token punctuation\">(</span>\n            finishedWork<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">===</span> finishedWork<span class=\"token punctuation\">.</span>type\n              <span class=\"token operator\">?</span> prevProps\n              <span class=\"token punctuation\">:</span> <span class=\"token function\">resolveDefaultProps</span><span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span> prevProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            prevState<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n          instance<span class=\"token punctuation\">.</span>__reactInternalSnapshotBeforeUpdate <span class=\"token operator\">=</span> snapshot<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> HostRoot<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> HostText<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> HostPortal<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> IncompleteClassComponent<span class=\"token punctuation\">:</span>\n      <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>commitMutationEffects</h3>\n<blockquote>\n<p>文件位置：react-reconciler/src/ReactFiberWorkLoop.js</p>\n</blockquote>\n<p>mutation phase 阶段调用链路：\ncommitRootImpl -->  commitMutationEffects --> commitWork</p>\n<p>代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitMutationEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> effectTag <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>effectTag<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> primaryEffectTag <span class=\"token operator\">=</span> effectTag <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>Placement <span class=\"token operator\">|</span> Update <span class=\"token operator\">|</span> Deletion<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>primaryEffectTag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> Placement<span class=\"token punctuation\">:</span>\n        <span class=\"token operator\">...</span>\n      <span class=\"token keyword\">case</span> PlacementAndUpdate<span class=\"token punctuation\">:</span>\n        <span class=\"token operator\">...</span>\n      <span class=\"token keyword\">case</span> Update<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n        <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">case</span> Deletion<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">commitDeletion</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>commitLayoutEffects</h3>\n<blockquote>\n<p>文件位置：react-reconciler/src/ReactFiberCommitWork.js</p>\n</blockquote>\n<p>layout phase 调用链路：commitRootImpl -->  commitLayoutEffects --> commitLifeCycles</p>\n<p>代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitLifeCycles</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">finishedRoot<span class=\"token punctuation\">:</span> FiberRoot<span class=\"token punctuation\">,</span>\n  current<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  finishedWork<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  committedExpirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> FunctionComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> ForwardRef<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> SimpleMemoComponent<span class=\"token punctuation\">:</span>\n      <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 属性 stateNode 表示对应组件的实例</span>\n      <span class=\"token comment\">// 在这里 class 组件实例执行 componentDidMount/DidUpdate</span>\n      <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Update<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 首次渲染时，还没有 current 树</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          instance<span class=\"token punctuation\">.</span><span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> prevProps <span class=\"token operator\">=</span>\n            finishedWork<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">===</span> finishedWork<span class=\"token punctuation\">.</span>type\n              <span class=\"token operator\">?</span> current<span class=\"token punctuation\">.</span>memoizedProps\n              <span class=\"token punctuation\">:</span> <span class=\"token function\">resolveDefaultProps</span><span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span> current<span class=\"token punctuation\">.</span>memoizedProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">const</span> prevState <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">;</span>\n          instance<span class=\"token punctuation\">.</span><span class=\"token function\">componentDidUpdate</span><span class=\"token punctuation\">(</span>\n            prevProps<span class=\"token punctuation\">,</span>\n            prevState<span class=\"token punctuation\">,</span>\n            instance<span class=\"token punctuation\">.</span>__reactInternalSnapshotBeforeUpdate<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">const</span> updateQueue <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>updateQueue<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updateQueue <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">commitUpdateQueue</span><span class=\"token punctuation\">(</span>\n          finishedWork<span class=\"token punctuation\">,</span>\n          updateQueue<span class=\"token punctuation\">,</span>\n          instance<span class=\"token punctuation\">,</span>\n          committedExpirationTime<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> HostRoot<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> HostText<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> HostPortal<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> Profiler<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> SuspenseComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> SuspenseListComponent<span class=\"token punctuation\">:</span>\n      <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>扩展</h2>\n<p>以下是一些关于 Fiber 的扩展内容。</p>\n<h3>调用链路</h3>\n<p>如下图所示，根据 React 源码绘制的调用链路图，主要罗列了一些比较重要的函数方法，可作为大家了解 Fiber 的参考。源码调试过程可以找到对应的函数方法打断点，以了解实际运行的过程，便于更好梳理出各个逻辑方法之间的关系。</p>\n<p><img src=\"https://p1.music.126.net/VU37zHp-6hAUfNaZbu3HRw==/109951165071751567.jpg\" alt=\"fiber调用链路.jpg\"></p>\n<h3>requestIdleCallback</h3>\n<p>之前有文章在总结 React Fiber 的调度原理时提到，客户端线程执行任务时会以帧的形式划分，在两个执行帧之间，主线程通常会有一小段空闲时间，在这个空闲期触发 requestIdleCallback 方法，能够执行一些优先级较低的 work。</p>\n<p>据说在早期的 React 版本上确实是这么做的，但使用 requestIdleCallback 实际上有一些限制，执行频次不足，以致于无法实现流畅的 UI 渲染，扩展性差。因此 React 团队放弃了 requestIdleCallback 用法，实现了自定义的版本。比如，在发布 v16.10 版本中，推出实验性的 Scheduler，尝试使用 postMessage 来代替 requestAnimationFrame。更多了解可以查看 React 源码 packages/scheduler 部分。</p>\n<h2>小结</h2>\n<p>Fiber 由来已久，可以说是 React 设计思想的一个典型表现。相比业界其他流行库更多采用当新数据到达时再计算模式，React 坚持拉取模式，即能够把计算资源延迟到必要时候再用，并且它知道，什么时候更适合执行，什么时候不执行。看起来虽然只是微小的区别，却意义很大。随着后续异步渲染能力等新特性的推出，我们有理由相信，在未来，React 将会在人机交互的应用中给我们带来更多的惊喜。</p>\n<h2>参考</h2>\n<ul>\n<li><a href=\"https://github.com/acdlite/react-fiber-architecture\">react-fiber-architecture</a></li>\n<li><a href=\"https://medium.com/react-in-depth/in-depth-explanation-of-state-and-props-update-in-react-51ab94563311\">In-depth explanation of state and props update in react</a></li>\n<li><a href=\"https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e\">in-depth overview of the new reconciliation algorithm in react</a></li>\n<li><a href=\"https://medium.com/react-in-depth/in-depth-explanation-of-state-and-props-update-in-react-51ab94563311\">The how and why on React’s usage of linked list in Fiber to walk the component’s tree</a></li>\n<li><a href=\"https://www.bilibili.com/video/av48384879/\">Effect List —— 又一个 Fiber 链表的构建过程</a></li>\n<li><a href=\"https://stackblitz.com/edit/js-ntqfil?file=index.js\">js-ntqfill</a></li>\n</ul>\n<blockquote>\n<p>本文发布自 <a href=\"https://github.com/x-orpheus\">网易云音乐大前端团队</a>，文章未经授权禁止任何形式的转载。我们常年招收前端、iOS、Android，如果你准备换工作，又恰好喜欢云音乐，那就加入我们 grp.music-fe(at)corp.netease.com！</p>\n</blockquote>","frontmatter":{"title":"React Fiber 源码解析","date":"2020-08-11","description":"React Fiber 由来已久，是 React 设计思想的一个典型表现。了解 Fiber 原理对我们更好理解 React 运行机制以及后续版本的新增特性，比如异步渲染能力等都有很大的帮助。本文基于 React v16 的源码，输出一些理解，希望对你也有帮助。"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/react-fiber/","previous":{"fields":{"slug":"/apng/"},"frontmatter":{"title":"Web 端 APNG 播放实现原理"}},"next":{"fields":{"slug":"/form/"},"frontmatter":{"title":"面向复杂场景的表单解决方案"}}}}}